<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار iPhone - Forsa</title>
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f6f3 0%, #f5f3f0 50%, #f0e6c7 100%);
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #b02e2e;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .step {
            background: #e7f3ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-right: 4px solid #b02e2e;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        
        button {
            background: linear-gradient(135deg, #b02e2e, #d63447);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            width: 100%;
        }
        
        .url-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 16px; /* Prevents zoom on iOS */
        }
        
        .device-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>📱 اختبار خاص بـ iPhone</h1>
        
        <div id="deviceInfo" class="device-info">
            <div>📱 الجهاز: <span id="deviceType">جاري التحقق...</span></div>
            <div>🌐 المتصفح: <span id="browserType">جاري التحقق...</span></div>
            <div>📱 iOS: <span id="iosVersion">جاري التحقق...</span></div>
            <div>🔗 السماح بالنوافذ المنبثقة: <span id="popupStatus">جاري التحقق...</span></div>
        </div>
        
        <div class="step">
            <h3>🔧 الخطوة 1: اختبار إعداد Google Sheets</h3>
            <input type="url" id="gsUrl" class="url-input" 
                   placeholder="ضع هنا رابط Google Apps Script">
            <button onclick="testGoogleSheets()">🧪 اختبار Google Sheets</button>
            <div id="gsResults"></div>
        </div>
        
        <div class="step">
            <h3>📲 الخطوة 2: محاكاة طلب من iPhone</h3>
            <button onclick="simulateIPhoneOrder()">📱 عمل طلب تجريبي من iPhone</button>
            <div id="orderResults"></div>
        </div>
        
        <div class="step">
            <h3>🔍 الخطوة 3: فحص لوحة الإدارة</h3>
            <button onclick="openAdminPanel()">🖥️ فتح لوحة الإدارة</button>
            <button onclick="checkLocalData()">📊 فحص البيانات المحلية</button>
            <div id="adminResults"></div>
        </div>
        
        <div class="step">
            <h3>🔧 الخطوة 4: اختبار خاص بـ Safari</h3>
            <button onclick="testSafariFeatures()">🧭 اختبار Safari المتقدم</button>
            <div id="safariResults"></div>
        </div>
    </div>

    <script>
        // Detect device and browser information
        function detectDevice() {
            const ua = navigator.userAgent;
            const deviceType = document.getElementById('deviceType');
            const browserType = document.getElementById('browserType');
            const iosVersion = document.getElementById('iosVersion');
            
            // Device detection
            if (/iPhone|iPad|iPod/.test(ua)) {
                deviceType.textContent = 'iOS Device ✅';
                deviceType.style.color = '#28a745';
                
                // iOS version
                const iosMatch = ua.match(/OS (\\d+)_(\\d+)/);
                if (iosMatch) {
                    iosVersion.textContent = `iOS ${iosMatch[1]}.${iosMatch[2]} ✅`;
                    iosVersion.style.color = '#28a745';
                }
            } else {
                deviceType.textContent = 'ليس iOS ⚠️';
                deviceType.style.color = '#ffc107';
            }
            
            // Browser detection
            if (/Safari/.test(ua) && !/Chrome/.test(ua)) {
                browserType.textContent = 'Safari ✅';
                browserType.style.color = '#28a745';
            } else if (/Chrome/.test(ua)) {
                browserType.textContent = 'Chrome ⚠️';
                browserType.style.color = '#ffc107';
            } else {
                browserType.textContent = 'Other Browser ❓';
                browserType.style.color = '#6c757d';
            }
        }
        
        async function testGoogleSheets() {
            const gsUrl = document.getElementById('gsUrl').value.trim();
            const resultsDiv = document.getElementById('gsResults');
            
            if (!gsUrl) {
                resultsDiv.innerHTML = '<div class="status error">❌ يرجى إدخال رابط Google Apps Script</div>';
                return;
            }
            
            localStorage.setItem('forsa_google_sheets_url', gsUrl);
            resultsDiv.innerHTML = '<div class="status info">⏳ جاري اختبار الاتصال...</div>';
            
            let results = '';
            
            // Test POST
            try {
                const testData = {
                    action: 'saveContact',
                    name: 'اختبار iPhone - ' + new Date().toLocaleTimeString(),
                    email: 'iphone-test@forsa.com',
                    message: 'اختبار من جهاز iPhone - ' + navigator.userAgent,
                    source: 'iphone_test'
                };
                
                await fetch(gsUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                results += '<div class="status success">✅ POST (إرسال البيانات): نجح</div>';
            } catch (error) {
                results += '<div class="status error">❌ POST فشل: ' + error.message + '</div>';
            }
            
            // Test GET
            try {
                const getUrl = gsUrl + '?action=getCompleteOrders&timestamp=' + Date.now();
                const response = await fetch(getUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    results += '<div class="status success">✅ GET (استقبال البيانات): نجح - ' + (data.data ? data.data.length : 0) + ' طلبات</div>';
                } else {
                    results += '<div class="status error">❌ GET فشل: HTTP ' + response.status + '</div>';
                }
            } catch (error) {
                results += '<div class="status error">❌ GET فشل: ' + error.message + '</div>';
            }
            
            resultsDiv.innerHTML = results;
        }
        
        function simulateIPhoneOrder() {
            const resultsDiv = document.getElementById('orderResults');
            
            const iPhoneOrder = {
                id: 'iphone_' + Date.now(),
                orderId: 'IPHONE-' + Math.floor(Math.random() * 10000),
                timestamp: new Date().toISOString(),
                customerName: 'عميلة من iPhone',
                customerPhone: '010' + Math.floor(Math.random() * 100000000).toString().padStart(8, '0'),
                customerEmail: 'iphone-customer@example.com',
                customerCity: 'القاهرة',
                customerAddress: 'شارع النيل - من iPhone',
                paymentMethod: 'cash_on_delivery',
                customerNotes: 'طلب من iPhone - ' + navigator.userAgent.substring(0, 50),
                products: [
                    {
                        name: 'حقيبة يد أنيقة',
                        category: 'حقائب يد',
                        price: '750',
                        quantity: 1
                    }
                ],
                totalItems: 1,
                totalAmount: 750,
                source: 'iphone_real_test',
                synced: false,
                deviceInfo: 'iPhone - ' + (navigator.userAgent.match(/iPhone OS ([0-9_]+)/) || ['', 'Unknown'])[1].replace(/_/g, '.'),
                isIPhoneTest: true
            };
            
            // Save to localStorage
            const completeOrders = JSON.parse(localStorage.getItem('forsa_complete_orders') || '[]');
            completeOrders.push(iPhoneOrder);
            localStorage.setItem('forsa_complete_orders', JSON.stringify(completeOrders));
            
            resultsDiv.innerHTML = '<div class="status success">✅ تم إنشاء طلب تجريبي من iPhone!<br>رقم الطلب: ' + iPhoneOrder.orderId + '<br>الآن افحص لوحة الإدارة</div>';
        }
        
        function openAdminPanel() {
            const resultsDiv = document.getElementById('adminResults');
            
            try {
                const adminWindow = window.open('admin-panel.html', '_blank', 'width=1200,height=800');
                if (adminWindow) {
                    resultsDiv.innerHTML = '<div class="status success">✅ تم فتح لوحة الإدارة في نافذة جديدة</div>';
                } else {
                    resultsDiv.innerHTML = '<div class="status warning">⚠️ النوافذ المنبثقة محجوبة. افتح admin-panel.html يدوياً</div>';
                }
            } catch (error) {
                resultsDiv.innerHTML = '<div class="status error">❌ خطأ في فتح لوحة الإدارة: ' + error.message + '</div>';
            }
        }
        
        function checkLocalData() {
            const resultsDiv = document.getElementById('adminResults');
            
            const contacts = JSON.parse(localStorage.getItem('forsa_contacts') || '[]');
            const completeOrders = JSON.parse(localStorage.getItem('forsa_complete_orders') || '[]');
            
            let results = '<div class="status info">📊 البيانات المحلية:</div>';
            results += '<div class="status info">📧 جهات الاتصال: ' + contacts.length + '</div>';
            results += '<div class="status info">🛍️ الطلبات الكاملة: ' + completeOrders.length + '</div>';
            
            // Count iPhone orders
            const iPhoneOrders = completeOrders.filter(o => o.source && o.source.includes('iphone'));
            if (iPhoneOrders.length > 0) {
                results += '<div class="status success">📱 طلبات iPhone: ' + iPhoneOrders.length + '</div>';
            }
            
            resultsDiv.innerHTML = results;
        }
        
        function testSafariFeatures() {
            const resultsDiv = document.getElementById('safariResults');
            
            let results = '<div class="status info">🧭 اختبار Safari المتقدم:</div>';
            
            // Test localStorage
            try {
                localStorage.setItem('safari_test', 'test');
                localStorage.removeItem('safari_test');
                results += '<div class="status success">✅ localStorage: يعمل</div>';
            } catch (error) {
                results += '<div class="status error">❌ localStorage: لا يعمل - ' + error.message + '</div>';
            }
            
            // Test fetch API
            if (typeof fetch !== 'undefined') {
                results += '<div class="status success">✅ Fetch API: متوفر</div>';
            } else {
                results += '<div class="status error">❌ Fetch API: غير متوفر</div>';
            }
            
            // Test popup capability
            const popupStatus = document.getElementById('popupStatus');
            try {
                const testWindow = window.open('', '_blank', 'width=1,height=1');
                if (testWindow) {
                    testWindow.close();
                    results += '<div class="status success">✅ النوافذ المنبثقة: مسموحة</div>';
                    popupStatus.textContent = 'مسموحة ✅';
                    popupStatus.style.color = '#28a745';
                } else {
                    results += '<div class="status warning">⚠️ النوافذ المنبثقة: محجوبة</div>';
                    popupStatus.textContent = 'محجوبة ⚠️';
                    popupStatus.style.color = '#ffc107';
                }
            } catch (error) {
                results += '<div class="status error">❌ النوافذ المنبثقة: خطأ - ' + error.message + '</div>';
                popupStatus.textContent = 'خطأ ❌';
                popupStatus.style.color = '#dc3545';
            }
            
            // Check Safari version
            if (/Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent)) {
                const safariVersion = navigator.userAgent.match(/Version\\/([0-9.]+)/);
                if (safariVersion) {
                    results += '<div class="status info">🧭 Safari Version: ' + safariVersion[1] + '</div>';
                }
            }
            
            resultsDiv.innerHTML = results;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            detectDevice();
            
            // Load saved Google Sheets URL
            const savedUrl = localStorage.getItem('forsa_google_sheets_url');
            if (savedUrl && savedUrl !== 'PASTE_YOUR_WEB_APP_URL_HERE') {
                document.getElementById('gsUrl').value = savedUrl;
            }
        });
    </script>
</body>
</html>