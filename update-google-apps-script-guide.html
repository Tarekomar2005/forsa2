<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تحديث Google Apps Script - عرض الطلبات من جميع الأجهزة</title>
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f6f3 0%, #f5f3f0 50%, #f0e6c7 100%);
        }
        
        .guide-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #b02e2e;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .urgent-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .step {
            background: #e7f3ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-right: 4px solid #b02e2e;
        }
        
        .code-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
        
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .warning-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        button {
            background: linear-gradient(135deg, #b02e2e, #d63447);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover { transform: translateY(-2px); }
        
        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        ol li {
            margin: 10px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="guide-container">
        <h1>🔄 تحديث Google Apps Script لعرض الطلبات من جميع الأجهزة</h1>
        
        <div class="urgent-box">
            ⚠️ <strong>مطلوب تحديث فوري:</strong> لكي تظهر الطلبات من التلفونات التانية في لوحة الإدارة، يجب تحديث Google Apps Script بالكود الجديد.
        </div>
        
        <div class="step">
            <h3>🔧 الخطوة 1: افتح Google Apps Script</h3>
            <ol>
                <li>اذهب إلى Google Sheets الخاص بك</li>
                <li>اضغط Extensions > Apps Script</li>
                <li>ستجد الكود القديم موجود</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>📝 الخطوة 2: استبدل الكود بالكامل</h3>
            <p><strong>امسح الكود القديم كله</strong> وضع هذا الكود الجديد مكانه:</p>
            
            <div class="code-box">
// Enhanced Google Apps Script for Forsa Website Database
// This handles contacts, quick orders, and complete orders

// Handle GET requests to fetch data
function doGet(e) {
  try {
    const action = e.parameter.action;
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    switch(action) {
      case 'getCompleteOrders':
        return getCompleteOrders(spreadsheet);
      case 'getAllData':
        return getAllData(spreadsheet);
      default:
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'Unknown action: ' + action
        })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('Error in doGet:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Get complete orders from Google Sheets
function getCompleteOrders(spreadsheet) {
  try {
    const completeOrderSheet = spreadsheet.getSheetByName('Complete Orders');
    
    if (!completeOrderSheet) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'success',
        data: [],
        message: 'No Complete Orders sheet found'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = completeOrderSheet.getDataRange().getValues();
    const headers = data[0];
    const orders = [];
    
    // Skip header row and process each order
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[1]) { // Check if order ID exists
        const order = {
          id: `gs_${i}`,
          orderId: row[1],
          timestamp: row[0],
          customerName: row[2],
          customerPhone: row[3],
          customerEmail: row[4] || '',
          customerCity: row[5] || '',
          customerAddress: row[6] || '',
          paymentMethod: row[7] || '',
          customerNotes: row[8] || '',
          products: parseProductsFromText(row[9]),
          totalItems: row[10] || 0,
          totalAmount: row[11] || 0,
          source: row[12] || 'google_sheets',
          synced: true,
          deviceInfo: 'External Device'
        };
        orders.push(order);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      data: orders,
      count: orders.length
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error getting complete orders:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Parse products text back to array format
function parseProductsFromText(productsText) {
  if (!productsText) return [];
  
  try {
    // Simple parsing for "Product Name (2x), Another Product (1x)" format
    const productStrings = productsText.split(', ');
    return productStrings.map((productStr, index) => {
      const match = productStr.match(/(.+) \\((\\d+)x\\)/);
      if (match) {
        return {
          name: match[1],
          quantity: parseInt(match[2]),
          price: '0', // Price not stored in this format
          category: 'منتج'
        };
      } else {
        return {
          name: productStr,
          quantity: 1,
          price: '0',
          category: 'منتج'
        };
      }
    });
  } catch (e) {
    console.error('Error parsing products:', e);
    return [{ name: productsText, quantity: 1, price: '0', category: 'منتج' }];
  }
}

// Get all data (contacts, orders, complete orders)
function getAllData(spreadsheet) {
  try {
    const completeOrdersResult = getCompleteOrders(spreadsheet);
    const completeOrdersData = JSON.parse(completeOrdersResult.getContent());
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      data: {
        completeOrders: completeOrdersData.data || [],
        contacts: [], // Can be implemented later if needed
        quickOrders: [] // Can be implemented later if needed
      },
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error getting all data:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    // Get the active spreadsheet
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // Handle different types of data
    switch(action) {
      case 'saveContact':
        return handleContactSubmission(spreadsheet, data);
      case 'saveOrder':
        return handleQuickOrderSubmission(spreadsheet, data);
      case 'saveCompleteOrder':
        return handleCompleteOrderSubmission(spreadsheet, data);
      default:
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'Unknown action: ' + action
        })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Handle contact form submissions
function handleContactSubmission(spreadsheet, data) {
  let contactSheet = spreadsheet.getSheetByName('Contacts');
  
  // Create sheet if it doesn't exist
  if (!contactSheet) {
    contactSheet = spreadsheet.insertSheet('Contacts');
    contactSheet.appendRow(['التاريخ', 'الاسم', 'البريد الإلكتروني', 'الرسالة', 'المصدر', 'IP Address']);
  }
  
  // Add the contact data
  contactSheet.appendRow([
    new Date(),
    data.name,
    data.email,
    data.message,
    data.source || 'website',
    data.ip || 'Unknown'
  ]);
  
  console.log('Contact saved:', data.name);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Contact saved successfully'
  })).setMimeType(ContentService.MimeType.JSON);
}

// Handle quick order submissions
function handleQuickOrderSubmission(spreadsheet, data) {
  let orderSheet = spreadsheet.getSheetByName('Quick Orders');
  
  // Create sheet if it doesn't exist
  if (!orderSheet) {
    orderSheet = spreadsheet.insertSheet('Quick Orders');
    orderSheet.appendRow(['التاريخ', 'اسم المنتج', 'السعر', 'الفئة', 'نوع الطلب', 'المصدر', 'IP Address']);
  }
  
  // Add the order data
  orderSheet.appendRow([
    new Date(),
    data.productName,
    data.productPrice,
    data.productCategory,
    data.orderType || 'quick_order',
    data.source || 'website',
    data.ip || 'Unknown'
  ]);
  
  console.log('Quick order saved:', data.productName);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Order saved successfully'
  })).setMimeType(ContentService.MimeType.JSON);
}

// Handle complete order submissions
function handleCompleteOrderSubmission(spreadsheet, data) {
  let completeOrderSheet = spreadsheet.getSheetByName('Complete Orders');
  
  // Create sheet if it doesn't exist
  if (!completeOrderSheet) {
    completeOrderSheet = spreadsheet.insertSheet('Complete Orders');
    completeOrderSheet.appendRow([
      'التاريخ', 'رقم الطلب', 'اسم العميل', 'رقم الهاتف', 'البريد الإلكتروني', 
      'المدينة', 'العنوان', 'طريقة الدفع', 'ملاحظات العميل',
      'المنتجات', 'عدد القطع', 'المبلغ الإجمالي', 'المصدر', 'IP Address'
    ]);
  }
  
  // Parse products if it's a string
  let productsText = '';
  if (typeof data.products === 'string') {
    try {
      const products = JSON.parse(data.products);
      productsText = products.map(p => `${p.name} (${p.quantity}x)`).join(', ');
    } catch (e) {
      productsText = data.products;
    }
  } else if (Array.isArray(data.products)) {
    productsText = data.products.map(p => `${p.name} (${p.quantity}x)`).join(', ');
  }
  
  // Add the complete order data
  completeOrderSheet.appendRow([
    new Date(),
    data.orderId,
    data.customerName,
    data.customerPhone,
    data.customerEmail || '',
    data.customerCity || '',
    data.customerAddress || '',
    data.paymentMethod || '',
    data.customerNotes || '',
    productsText,
    data.totalItems || 0,
    data.totalAmount || 0,
    data.source || 'website',
    data.ip || 'Unknown'
  ]);
  
  console.log('Complete order saved:', data.orderId);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Complete order saved successfully',
    orderId: data.orderId
  })).setMimeType(ContentService.MimeType.JSON);
}
            </div>
        </div>
        
        <div class="step">
            <h3>🚀 الخطوة 3: إعادة النشر</h3>
            <ol>
                <li>اضغط <span class="highlight">Deploy > Manage deployments</span></li>
                <li>اضغط على الأيقونة ✏️ (Edit) بجانب النشر الحالي</li>
                <li>غير الـ <span class="highlight">Version</span> إلى <strong>New version</strong></li>
                <li>اضغط <span class="highlight">Deploy</span></li>
                <li><strong>انسخ الرابط الجديد</strong> (أو استخدم نفس الرابط القديم)</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>✅ الخطوة 4: اختبار النظام المحدث</h3>
            <ol>
                <li>ارجع للوحة الإدارة</li>
                <li>اضغط "اختبار الاتصال"</li>
                <li>المفروض تشوف: <strong>✅ نجح الاختبار بالكامل!</strong></li>
                <li>اضغط "تحديث من جميع المصادر"</li>
            </ol>
        </div>
        
        <div class="success-box">
            <h3>🎉 النتيجة المتوقعة:</h3>
            <ul>
                <li>✅ <strong>الكتابة إلى Google Sheets:</strong> ✅ (حفظ الطلبات الجديدة)</li>
                <li>✅ <strong>القراءة من Google Sheets:</strong> ✅ (عرض الطلبات من جميع الأجهزة)</li>
                <li>✅ <strong>لوحة الإدارة:</strong> تظهر الطلبات من جميع التلفونات</li>
            </ul>
        </div>
        
        <div class="warning-box">
            <h4>🚨 ملاحظة مهمة:</h4>
            <p>إذا كان الاختبار يظهر:</p>
            <ul>
                <li><strong>الكتابة: ✅ القراءة: ❌</strong> → تحتاج إعادة نشر مع New version</li>
                <li><strong>الكتابة: ❌ القراءة: ❌</strong> → تأكد من الكود والرابط</li>
            </ul>
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <button onclick="window.open('admin-panel.html', '_blank')">
                🔧 افتح لوحة الإدارة للاختبار
            </button>
            <button onclick="copyCode()">
                📋 انسخ الكود
            </button>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
            <p><strong>💡 بعد التحديث:</strong> الطلبات من جميع التلفونات ستظهر في لوحة الإدارة تلقائياً! 🎯</p>
        </div>
    </div>

    <script>
        function copyCode() {
            const codeElement = document.querySelector('.code-box');
            const codeText = codeElement.textContent;
            
            navigator.clipboard.writeText(codeText).then(function() {
                alert('✅ تم نسخ الكود! الآن الصقه في Google Apps Script.');
            }, function(err) {
                console.error('Could not copy text: ', err);
                alert('❌ فشل في النسخ. انسخ الكود يدوياً من المربع الأزرق.');
            });
        }
    </script>
</body>
</html>