<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ø¯ÙŠØ« Google Apps Script - Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</title>
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f6f3 0%, #f5f3f0 50%, #f0e6c7 100%);
        }
        
        .guide-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #b02e2e;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .urgent-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .step {
            background: #e7f3ff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-right: 4px solid #b02e2e;
        }
        
        .code-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            direction: ltr;
            text-align: left;
        }
        
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .warning-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        button {
            background: linear-gradient(135deg, #b02e2e, #d63447);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover { transform: translateY(-2px); }
        
        .highlight {
            background: yellow;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        ol li {
            margin: 10px 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="guide-container">
        <h1>ğŸ”„ ØªØ­Ø¯ÙŠØ« Google Apps Script Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h1>
        
        <div class="urgent-box">
            âš ï¸ <strong>Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ:</strong> Ù„ÙƒÙŠ ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„ØªÙ„ÙÙˆÙ†Ø§Øª Ø§Ù„ØªØ§Ù†ÙŠØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ« Google Apps Script Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯.
        </div>
        
        <div class="step">
            <h3>ğŸ”§ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§ÙØªØ­ Google Apps Script</h3>
            <ol>
                <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Google Sheets Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</li>
                <li>Ø§Ø¶ØºØ· Extensions > Apps Script</li>
                <li>Ø³ØªØ¬Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…ÙˆØ¬ÙˆØ¯</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>ğŸ“ Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</h3>
            <p><strong>Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒÙ„Ù‡</strong> ÙˆØ¶Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù†Ù‡:</p>
            
            <div class="code-box">
// Enhanced Google Apps Script for Forsa Website Database
// This handles contacts, quick orders, and complete orders

// Handle GET requests to fetch data
function doGet(e) {
  try {
    const action = e.parameter.action;
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    switch(action) {
      case 'getCompleteOrders':
        return getCompleteOrders(spreadsheet);
      case 'getAllData':
        return getAllData(spreadsheet);
      default:
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'Unknown action: ' + action
        })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('Error in doGet:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Get complete orders from Google Sheets
function getCompleteOrders(spreadsheet) {
  try {
    const completeOrderSheet = spreadsheet.getSheetByName('Complete Orders');
    
    if (!completeOrderSheet) {
      return ContentService.createTextOutput(JSON.stringify({
        status: 'success',
        data: [],
        message: 'No Complete Orders sheet found'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const data = completeOrderSheet.getDataRange().getValues();
    const headers = data[0];
    const orders = [];
    
    // Skip header row and process each order
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      if (row[1]) { // Check if order ID exists
        const order = {
          id: `gs_${i}`,
          orderId: row[1],
          timestamp: row[0],
          customerName: row[2],
          customerPhone: row[3],
          customerEmail: row[4] || '',
          customerCity: row[5] || '',
          customerAddress: row[6] || '',
          paymentMethod: row[7] || '',
          customerNotes: row[8] || '',
          products: parseProductsFromText(row[9]),
          totalItems: row[10] || 0,
          totalAmount: row[11] || 0,
          source: row[12] || 'google_sheets',
          synced: true,
          deviceInfo: 'External Device'
        };
        orders.push(order);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      data: orders,
      count: orders.length
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error getting complete orders:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Parse products text back to array format
function parseProductsFromText(productsText) {
  if (!productsText) return [];
  
  try {
    // Simple parsing for "Product Name (2x), Another Product (1x)" format
    const productStrings = productsText.split(', ');
    return productStrings.map((productStr, index) => {
      const match = productStr.match(/(.+) \\((\\d+)x\\)/);
      if (match) {
        return {
          name: match[1],
          quantity: parseInt(match[2]),
          price: '0', // Price not stored in this format
          category: 'Ù…Ù†ØªØ¬'
        };
      } else {
        return {
          name: productStr,
          quantity: 1,
          price: '0',
          category: 'Ù…Ù†ØªØ¬'
        };
      }
    });
  } catch (e) {
    console.error('Error parsing products:', e);
    return [{ name: productsText, quantity: 1, price: '0', category: 'Ù…Ù†ØªØ¬' }];
  }
}

// Get all data (contacts, orders, complete orders)
function getAllData(spreadsheet) {
  try {
    const completeOrdersResult = getCompleteOrders(spreadsheet);
    const completeOrdersData = JSON.parse(completeOrdersResult.getContent());
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      data: {
        completeOrders: completeOrdersData.data || [],
        contacts: [], // Can be implemented later if needed
        quickOrders: [] // Can be implemented later if needed
      },
      timestamp: new Date().toISOString()
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    console.error('Error getting all data:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    
    // Get the active spreadsheet
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // Handle different types of data
    switch(action) {
      case 'saveContact':
        return handleContactSubmission(spreadsheet, data);
      case 'saveOrder':
        return handleQuickOrderSubmission(spreadsheet, data);
      case 'saveCompleteOrder':
        return handleCompleteOrderSubmission(spreadsheet, data);
      default:
        return ContentService.createTextOutput(JSON.stringify({
          status: 'error',
          message: 'Unknown action: ' + action
        })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    console.error('Error in doPost:', error);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Handle contact form submissions
function handleContactSubmission(spreadsheet, data) {
  let contactSheet = spreadsheet.getSheetByName('Contacts');
  
  // Create sheet if it doesn't exist
  if (!contactSheet) {
    contactSheet = spreadsheet.insertSheet('Contacts');
    contactSheet.appendRow(['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø§Ø³Ù…', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'Ø§Ù„Ù…ØµØ¯Ø±', 'IP Address']);
  }
  
  // Add the contact data
  contactSheet.appendRow([
    new Date(),
    data.name,
    data.email,
    data.message,
    data.source || 'website',
    data.ip || 'Unknown'
  ]);
  
  console.log('Contact saved:', data.name);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Contact saved successfully'
  })).setMimeType(ContentService.MimeType.JSON);
}

// Handle quick order submissions
function handleQuickOrderSubmission(spreadsheet, data) {
  let orderSheet = spreadsheet.getSheetByName('Quick Orders');
  
  // Create sheet if it doesn't exist
  if (!orderSheet) {
    orderSheet = spreadsheet.insertSheet('Quick Orders');
    orderSheet.appendRow(['Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬', 'Ø§Ù„Ø³Ø¹Ø±', 'Ø§Ù„ÙØ¦Ø©', 'Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨', 'Ø§Ù„Ù…ØµØ¯Ø±', 'IP Address']);
  }
  
  // Add the order data
  orderSheet.appendRow([
    new Date(),
    data.productName,
    data.productPrice,
    data.productCategory,
    data.orderType || 'quick_order',
    data.source || 'website',
    data.ip || 'Unknown'
  ]);
  
  console.log('Quick order saved:', data.productName);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Order saved successfully'
  })).setMimeType(ContentService.MimeType.JSON);
}

// Handle complete order submissions
function handleCompleteOrderSubmission(spreadsheet, data) {
  let completeOrderSheet = spreadsheet.getSheetByName('Complete Orders');
  
  // Create sheet if it doesn't exist
  if (!completeOrderSheet) {
    completeOrderSheet = spreadsheet.insertSheet('Complete Orders');
    completeOrderSheet.appendRow([
      'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨', 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„', 'Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 
      'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„',
      'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', 'Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹', 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', 'Ø§Ù„Ù…ØµØ¯Ø±', 'IP Address'
    ]);
  }
  
  // Parse products if it's a string
  let productsText = '';
  if (typeof data.products === 'string') {
    try {
      const products = JSON.parse(data.products);
      productsText = products.map(p => `${p.name} (${p.quantity}x)`).join(', ');
    } catch (e) {
      productsText = data.products;
    }
  } else if (Array.isArray(data.products)) {
    productsText = data.products.map(p => `${p.name} (${p.quantity}x)`).join(', ');
  }
  
  // Add the complete order data
  completeOrderSheet.appendRow([
    new Date(),
    data.orderId,
    data.customerName,
    data.customerPhone,
    data.customerEmail || '',
    data.customerCity || '',
    data.customerAddress || '',
    data.paymentMethod || '',
    data.customerNotes || '',
    productsText,
    data.totalItems || 0,
    data.totalAmount || 0,
    data.source || 'website',
    data.ip || 'Unknown'
  ]);
  
  console.log('Complete order saved:', data.orderId);
  
  return ContentService.createTextOutput(JSON.stringify({
    status: 'success',
    message: 'Complete order saved successfully',
    orderId: data.orderId
  })).setMimeType(ContentService.MimeType.JSON);
}
            </div>
        </div>
        
        <div class="step">
            <h3>ğŸš€ Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø±</h3>
            <ol>
                <li>Ø§Ø¶ØºØ· <span class="highlight">Deploy > Manage deployments</span></li>
                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© âœï¸ (Edit) Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</li>
                <li>ØºÙŠØ± Ø§Ù„Ù€ <span class="highlight">Version</span> Ø¥Ù„Ù‰ <strong>New version</strong></li>
                <li>Ø§Ø¶ØºØ· <span class="highlight">Deploy</span></li>
                <li><strong>Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯</strong> (Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù‚Ø¯ÙŠÙ…)</li>
            </ol>
        </div>
        
        <div class="step">
            <h3>âœ… Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«</h3>
            <ol>
                <li>Ø§Ø±Ø¬Ø¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</li>
                <li>Ø§Ø¶ØºØ· "Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„"</li>
                <li>Ø§Ù„Ù…ÙØ±ÙˆØ¶ ØªØ´ÙˆÙ: <strong>âœ… Ù†Ø¬Ø­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„ÙƒØ§Ù…Ù„!</strong></li>
                <li>Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ« Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±"</li>
            </ol>
        </div>
        
        <div class="success-box">
            <h3>ğŸ‰ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:</h3>
            <ul>
                <li>âœ… <strong>Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ù‰ Google Sheets:</strong> âœ… (Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</li>
                <li>âœ… <strong>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Google Sheets:</strong> âœ… (Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©)</li>
                <li>âœ… <strong>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</strong> ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ„ÙÙˆÙ†Ø§Øª</li>
            </ul>
        </div>
        
        <div class="warning-box">
            <h4>ğŸš¨ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</h4>
            <p>Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¸Ù‡Ø±:</p>
            <ul>
                <li><strong>Ø§Ù„ÙƒØªØ§Ø¨Ø©: âœ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: âŒ</strong> â†’ ØªØ­ØªØ§Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø± Ù…Ø¹ New version</li>
                <li><strong>Ø§Ù„ÙƒØªØ§Ø¨Ø©: âŒ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: âŒ</strong> â†’ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø±Ø§Ø¨Ø·</li>
            </ul>
        </div>
        
        <div style="text-align: center; margin-top: 40px;">
            <button onclick="window.open('admin-panel.html', '_blank')">
                ğŸ”§ Ø§ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
            </button>
            <button onclick="copyCode()">
                ğŸ“‹ Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯
            </button>
        </div>
        
        <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
            <p><strong>ğŸ’¡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:</strong> Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ„ÙÙˆÙ†Ø§Øª Ø³ØªØ¸Ù‡Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹! ğŸ¯</p>
        </div>
    </div>

    <script>
        function copyCode() {
            const codeElement = document.querySelector('.code-box');
            const codeText = codeElement.textContent;
            
            navigator.clipboard.writeText(codeText).then(function() {
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯! Ø§Ù„Ø¢Ù† Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Google Apps Script.');
            }, function(err) {
                console.error('Could not copy text: ', err);
                alert('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®. Ø§Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ø²Ø±Ù‚.');
            });
        }
    </script>
</body>
</html>