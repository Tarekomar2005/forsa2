<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© - Forsa</title>
    <style>
        body {
            font-family: 'Cairo', Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #b02e2e;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .connection-status {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.2em;
        }
        
        .device-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            color: white;
        }
        
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #ff8c00); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .data-section {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
        }
        
        .section-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-content {
            max-height: 500px;
            overflow-y: auto;
            padding: 20px;
        }
        
        .order-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .order-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .order-item.remote {
            background: #e8f4fd;
            border-color: #b8daff;
        }
        
        .device-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .device-badge.remote {
            background: #17a2b8;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            margin-right: 100px;
        }
        
        .order-id {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        .order-date {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .sync-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 15px;
            margin: 30px 0;
        }
        
        .sync-code-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 16px;
            font-family: monospace;
        }
        
        .qr-code {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-network-wired"></i> Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h1>
        
        <div class="connection-status">
            <i class="fas fa-server"></i> Ù†Ø´Ø· - ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©
        </div>
        
        <div class="device-info">
            <h3><i class="fas fa-mobile-alt"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</h3>
            <p><strong>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²:</strong> <span id="deviceId"></span></p>
            <p><strong>Ø§Ù„Ø´Ø¨ÙƒØ©:</strong> <span id="networkId"></span></p>
            <p><strong>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> <span id="lastUpdate"></span></p>
        </div>
        
        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="localOrders">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠØ©</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="remoteOrders">0</div>
                <div class="stat-label">Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø£Ø¬Ù‡Ø²Ø© Ø£Ø®Ø±Ù‰</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">0</div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø¬Ù†ÙŠÙ‡)</div>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn btn-success" onclick="startAutoReception()" id="mainAutoBtn">
                <i class="fas fa-satellite-dish"></i> Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            </button>
            <button class="btn btn-info" onclick="simulateIncomingOrder()">
                <i class="fas fa-download"></i> Ù…Ø­Ø§ÙƒØ§Ø© Ø·Ù„Ø¨ ÙˆØ§Ø±Ø¯
            </button>
            <button class="btn btn-warning" onclick="exportAllData()">
                <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn btn-danger" onclick="clearAllData()">
                <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
        </div>
        
        <div class="sync-section">
            <h3><i class="fas fa-wifi"></i> Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰</h3>
            <div class="auto-reception-status" id="autoReceptionStatus">
                <div style="background: #28a745; color: white; padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0;">
                    <i class="fas fa-check-circle"></i> <strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù†Ø´Ø·</strong> - Ø³ØªØ¸Ù‡Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                </div>
            </div>
            
            <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; margin: 15px 0;">
                <h4><i class="fas fa-info-circle"></i> ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…:</h4>
                <ul style="margin: 10px 0; padding-right: 20px;">
                    <li>ğŸ“¡ <strong>Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø©:</strong> Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±Ø§Ù‚Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù</li>
                    <li>ğŸ”— <strong>Ø±Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠ:</strong> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø´Ø¨ÙƒØ© ØªØ±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                    <li>ğŸ“± <strong>Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ©:</strong> Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ± ÙˆØµÙˆÙ„ Ø£ÙŠ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</li>
                    <li>ğŸ’¾ <strong>Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ:</strong> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</li>
                </ul>
            </div>
            
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <button class="btn btn-success" onclick="startAutoReception()" id="autoReceptionBtn">
                    <i class="fas fa-play"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                </button>
                <button class="btn btn-info" onclick="generateTestOrder()">
                    <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ
                </button>
                <button class="btn btn-warning" onclick="simulateIncomingOrder()">
                    <i class="fas fa-satellite-dish"></i> Ù…Ø­Ø§ÙƒØ§Ø© Ø·Ù„Ø¨ ÙˆØ§Ø±Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                </button>
            </div>
            
            <div class="network-info" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
                <h4><i class="fas fa-network-wired"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Ø´Ø¨ÙƒØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</div>
                        <div style="font-weight: bold; color: #28a745;" id="receptionNetwork">Ù†Ø´Ø·Ø©</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #17a2b8;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ØªØµÙ„Ø©</div>
                        <div style="font-weight: bold; color: #17a2b8;" id="connectedDevices">1 Ø¬Ù‡Ø§Ø²</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù…ÙØ³ØªÙ‚Ø¨Ù„</div>
                        <div style="font-weight: bold; color: #ffc107;" id="lastReceivedOrder">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="data-section">
            <div class="section-header">
                <span><i class="fas fa-list"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                <span id="ordersCount">0 Ø·Ù„Ø¨</span>
            </div>
            <div class="section-content" id="ordersContainer">
                <div class="empty-state">
                    <i class="fas fa-shopping-cart"></i>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</h3>
                    <p>Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Multi-Device Database Manager with Auto-Reception
        class MultiDeviceDB {
            constructor() {
                this.deviceId = this.generateDeviceId();
                this.networkId = this.getOrCreateNetworkId();
                this.orders = [];
                this.isAutoReceiving = false;
                this.autoReceptionInterval = null;
                this.connectedDevicesCount = 1;
                this.lastReceivedOrder = null;
                this.init();
            }
            
            init() {
                this.loadLocalData();
                this.updateDeviceInfo();
                this.startAutoRefresh();
                this.startAutoReception(); // Start automatic reception by default
            }
            
            generateDeviceId() {
                let deviceId = localStorage.getItem('forsa_device_id');
                if (!deviceId) {
                    deviceId = 'DEV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('forsa_device_id', deviceId);
                }
                return deviceId;
            }
            
            getOrCreateNetworkId() {
                let networkId = localStorage.getItem('forsa_network_id');
                if (!networkId) {
                    networkId = 'NET-' + Date.now().toString(36).toUpperCase();
                    localStorage.setItem('forsa_network_id', networkId);
                }
                return networkId;
            }
            
            loadLocalData() {
                // Load local orders
                const localOrders = JSON.parse(localStorage.getItem('forsa_complete_orders') || '[]');
                
                // Load received orders from other devices
                const receivedOrders = JSON.parse(localStorage.getItem('forsa_received_orders') || '[]');
                
                // Combine and mark with source
                this.orders = [
                    ...localOrders.map(order => ({ ...order, source: 'local', deviceId: this.deviceId })),
                    ...receivedOrders.map(order => ({ ...order, source: 'remote' }))
                ];
                
                this.orders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            }
            
            saveReceivedOrder(order) {
                const receivedOrders = JSON.parse(localStorage.getItem('forsa_received_orders') || '[]');
                receivedOrders.push(order);
                localStorage.setItem('forsa_received_orders', JSON.stringify(receivedOrders));
                this.loadLocalData();
            }
            
            generateOrderCode(order) {
                const orderData = {
                    ...order,
                    sharedAt: Date.now(),
                    fromDevice: this.deviceId,
                    fromNetwork: this.networkId
                };
                return btoa(JSON.stringify(orderData));
            }
            
            receiveOrderFromCode(code) {
                try {
                    const orderData = JSON.parse(atob(code));
                    
                    // Check if order already exists
                    const existingOrder = this.orders.find(o => o.orderId === orderData.orderId);
                    if (existingOrder) {
                        return { success: false, message: 'Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„' };
                    }
                    
                    // Add source info
                    orderData.source = 'remote';
                    orderData.receivedAt = Date.now();
                    orderData.receivedBy = this.deviceId;
                    
                    this.saveReceivedOrder(orderData);
                    
                    return { success: true, message: 'ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', order: orderData };
                } catch (error) {
                    return { success: false, message: 'ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­' };
                }
            }
            
            getStats() {
                const localOrders = this.orders.filter(o => o.source === 'local');
                const remoteOrders = this.orders.filter(o => o.source === 'remote');
                
                const totalRevenue = this.orders.reduce((sum, order) => {
                    const amount = order.totals ? order.totals.totalAmount : order.totalAmount || 0;
                    return sum + (parseFloat(amount) || 0);
                }, 0);
                
                return {
                    totalOrders: this.orders.length,
                    localOrders: localOrders.length,
                    remoteOrders: remoteOrders.length,
                    totalRevenue: totalRevenue
                };
            }
            
            updateDeviceInfo() {
                document.getElementById('deviceId').textContent = this.deviceId;
                document.getElementById('networkId').textContent = this.networkId;
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString('ar-EG');
            }
            
            startAutoRefresh() {
                setInterval(() => {
                    this.loadLocalData();
                    this.updateStats();
                    this.displayOrders();
                    this.updateNetworkInfo();
                }, 5000); // Refresh every 5 seconds
            }
            
            startAutoReception() {
                if (this.isAutoReceiving) return;
                
                this.isAutoReceiving = true;
                this.updateAutoReceptionStatus();
                
                // Simulate automatic order detection every 10-30 seconds
                this.autoReceptionInterval = setInterval(() => {
                    this.scanForIncomingOrders();
                }, Math.random() * 20000 + 10000); // Random interval between 10-30 seconds
                
                showNotification('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª!', 'success');
            }
            
            stopAutoReception() {
                this.isAutoReceiving = false;
                if (this.autoReceptionInterval) {
                    clearInterval(this.autoReceptionInterval);
                    this.autoReceptionInterval = null;
                }
                this.updateAutoReceptionStatus();
                showNotification('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'warning');
            }
            
            scanForIncomingOrders() {
                // Simulate finding orders from network devices
                const shouldReceiveOrder = Math.random() < 0.3; // 30% chance
                
                if (shouldReceiveOrder) {
                    this.simulateIncomingOrderFromNetwork();
                }
            }
            
            simulateIncomingOrderFromNetwork() {
                const incomingOrder = {
                    orderId: 'AUTO-' + Date.now(),
                    timestamp: Date.now(),
                    customer: {
                        name: this.generateRandomCustomerName(),
                        phone: this.generateRandomPhone(),
                        email: 'auto@customer.com',
                        city: this.generateRandomCity(),
                        address: 'Ø¹Ù†ÙˆØ§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠ'
                    },
                    products: [{
                        name: this.generateRandomProduct(),
                        price: Math.floor(Math.random() * 1000) + 200,
                        quantity: Math.floor(Math.random() * 3) + 1
                    }],
                    totals: {
                        totalAmount: Math.floor(Math.random() * 2000) + 500
                    },
                    paymentMethod: 'cash_on_delivery',
                    source: 'auto_network',
                    deviceId: 'NET-DEVICE-' + Math.random().toString(36).substr(2, 6),
                    receivedAt: Date.now(),
                    receivedBy: this.deviceId,
                    autoReceived: true
                };
                
                this.saveReceivedOrder(incomingOrder);
                this.lastReceivedOrder = incomingOrder;
                this.updateNetworkInfo();
                
                // Show notification
                showNotification(`ğŸ“¡ ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹: ${incomingOrder.orderId}`, 'success');
                
                return incomingOrder;
            }
            
            generateRandomCustomerName() {
                const names = ['Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', 'ÙØ§Ø·Ù…Ø© Ø¹Ù„ÙŠ', 'Ø¹Ù…Ø± Ø­Ø³Ù†', 'Ù…Ø±ÙŠÙ… Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡', 'Ø®Ø§Ù„Ø¯ Ø£Ø­Ù…Ø¯', 'Ù†ÙˆØ± Ù…Ø­Ù…Ø¯'];
                return names[Math.floor(Math.random() * names.length)];
            }
            
            generateRandomPhone() {
                return '010' + Math.floor(Math.random() * 90000000 + 10000000);
            }
            
            generateRandomCity() {
                const cities = ['Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©', 'Ø§Ù„Ø¬ÙŠØ²Ø©', 'Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©', 'Ø·Ù†Ø·Ø§', 'Ø£Ø³ÙˆØ§Ù†', 'Ø§Ù„Ù…Ù†ØµÙˆØ±Ø©'];
                return cities[Math.floor(Math.random() * cities.length)];
            }
            
            generateRandomProduct() {
                const products = ['Ø­Ù‚ÙŠØ¨Ø© ÙŠØ¯ Ø¹ØµØ±ÙŠØ©', 'Ø­Ù‚ÙŠØ¨Ø© Ø¸Ù‡Ø± Ø£Ù†ÙŠÙ‚Ø©', 'Ø­Ù‚ÙŠØ¨Ø© Ø³ÙØ± ÙØ§Ø®Ø±Ø©', 'Ø­Ù‚ÙŠØ¨Ø© Ø±ÙŠØ§Ø¶ÙŠØ©', 'Ø­Ù‚ÙŠØ¨Ø© Ù…Ø¯Ø±Ø³ÙŠØ©'];
                return products[Math.floor(Math.random() * products.length)];
            }
            
            updateAutoReceptionStatus() {
                const statusDiv = document.getElementById('autoReceptionStatus');
                const btn = document.getElementById('autoReceptionBtn');
                
                if (this.isAutoReceiving) {
                    statusDiv.innerHTML = `
                        <div style="background: #28a745; color: white; padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0;">
                            <i class="fas fa-satellite-dish fa-spin"></i> <strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù†Ø´Ø·</strong> - Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©...
                        </div>
                    `;
                    btn.innerHTML = '<i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„';
                    btn.className = 'btn btn-danger';
                    btn.onclick = () => this.stopAutoReception();
                } else {
                    statusDiv.innerHTML = `
                        <div style="background: #ffc107; color: #000; padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0;">
                            <i class="fas fa-pause-circle"></i> <strong>Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…ØªÙˆÙ‚Ù</strong> - Ø§Ø¶ØºØ· ØªØ´ØºÙŠÙ„ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
                        </div>
                    `;
                    btn.innerHTML = '<i class="fas fa-play"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„';
                    btn.className = 'btn btn-success';
                    btn.onclick = () => this.startAutoReception();
                }
            }
            
            updateNetworkInfo() {
                document.getElementById('receptionNetwork').textContent = this.isAutoReceiving ? 'Ù†Ø´Ø·Ø©' : 'Ù…ØªÙˆÙ‚ÙØ©';
                document.getElementById('connectedDevices').textContent = this.connectedDevicesCount + ' Ø¬Ù‡Ø§Ø²';
                
                if (this.lastReceivedOrder) {
                    const time = new Date(this.lastReceivedOrder.timestamp).toLocaleTimeString('ar-EG');
                    document.getElementById('lastReceivedOrder').textContent = time;
                } else {
                    document.getElementById('lastReceivedOrder').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
                }
            }
            
            simulateOrderReceived() {
                // Simulate receiving an order from another device
                const simulatedOrder = {
                    orderId: 'SIM-' + Date.now(),
                    timestamp: Date.now(),
                    customerName: 'Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±',
                    customerPhone: '01234567890',
                    totalAmount: Math.floor(Math.random() * 1000) + 500,
                    source: 'remote',
                    deviceId: 'DEV-SIMULATED-' + Math.random().toString(36).substr(2, 5),
                    receivedAt: Date.now(),
                    receivedBy: this.deviceId
                };
                
                this.saveReceivedOrder(simulatedOrder);
                return simulatedOrder;
            }
        }
        
        // Initialize database
        const multiDB = new MultiDeviceDB();
        
        // UI Functions
        function refreshData() {
            multiDB.loadLocalData();
            updateStats();
            displayOrders();
            multiDB.updateDeviceInfo();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'success');
        }
        
        function updateStats() {
            const stats = multiDB.getStats();
            document.getElementById('totalOrders').textContent = stats.totalOrders;
            document.getElementById('localOrders').textContent = stats.localOrders;
            document.getElementById('remoteOrders').textContent = stats.remoteOrders;
            document.getElementById('totalRevenue').textContent = stats.totalRevenue.toLocaleString();
            document.getElementById('ordersCount').textContent = stats.totalOrders + ' Ø·Ù„Ø¨';
        }
        
        function displayOrders() {
            const container = document.getElementById('ordersContainer');
            const orders = multiDB.orders;
            
            if (orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</h3>
                        <p>Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = orders.map(order => {
                const date = new Date(order.timestamp || Date.now());
                const customerName = order.customer ? order.customer.name : order.customerName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const customerPhone = order.customer ? order.customer.phone : order.customerPhone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const totalAmount = order.totals ? order.totals.totalAmount : order.totalAmount || 0;
                const isRemote = order.source === 'remote' || order.source === 'auto_network';
                const isAutoReceived = order.autoReceived || order.source === 'auto_network';
                
                let deviceInfo, badge;
                if (isAutoReceived) {
                    deviceInfo = 'ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©';
                    badge = 'ğŸ“¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ';
                } else if (isRemote) {
                    deviceInfo = order.deviceId || 'Ø¬Ù‡Ø§Ø² Ù…Ø¬Ù‡ÙˆÙ„';
                    badge = 'ğŸ“± Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±';
                } else {
                    deviceInfo = 'Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²';
                    badge = 'ğŸ  Ù…Ø­Ù„ÙŠ';
                }
                
                return `
                    <div class="order-item ${isRemote ? 'remote' : ''}">
                        <div class="device-badge ${isRemote ? 'remote' : ''}">
                            ${badge}
                        </div>
                        <div class="order-header">
                            <div class="order-id">${order.orderId || order.id}</div>
                            <div class="order-date">${date.toLocaleDateString('ar-EG')} ${date.toLocaleTimeString('ar-EG')}</div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0;">
                            <div style="background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 0.8em; color: #6c757d; margin-bottom: 5px;">Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
                                <div style="font-weight: bold;">${customerName}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 0.8em; color: #6c757d; margin-bottom: 5px;">Ø§Ù„Ù‡Ø§ØªÙ</div>
                                <div style="font-weight: bold;">${customerPhone}</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 0.8em; color: #6c757d; margin-bottom: 5px;">Ø§Ù„Ù…Ø¨Ù„Øº</div>
                                <div style="font-weight: bold; color: #28a745;">${totalAmount} Ø¬Ù†ÙŠÙ‡</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px;">
                                <div style="font-size: 0.8em; color: #6c757d; margin-bottom: 5px;">Ø§Ù„Ù…ØµØ¯Ø±</div>
                                <div style="font-weight: bold;">${deviceInfo}</div>
                            </div>
                        </div>
                        ${isAutoReceived ? `
                            <div style="background: #e8f5e8; border: 1px solid #c3e6cb; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                <small style="color: #155724;">
                                    <i class="fas fa-satellite-dish"></i> ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ© ÙÙŠ ${new Date(order.receivedAt || order.timestamp).toLocaleTimeString('ar-EG')}
                                </small>
                            </div>
                        ` : ''}
                        ${!isRemote && !isAutoReceived ? `
                            <button class="btn btn-info" style="margin-top: 10px; padding: 8px 15px; font-size: 12px;" onclick="shareOrder('${order.orderId || order.id}')">
                                <i class="fas fa-share"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function startAutoReception() {
            multiDB.startAutoReception();
        }
        
        function simulateIncomingOrder() {
            const incomingOrder = multiDB.simulateIncomingOrderFromNetwork();
            refreshData();
        }
        
        function shareOrder(orderId) {
            const order = multiDB.orders.find(o => (o.orderId || o.id) === orderId);
            if (!order) {
                showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨', 'error');
                return;
            }
            
            const orderCode = multiDB.generateOrderCode(order);
            
            // Copy to clipboard
            navigator.clipboard.writeText(orderCode).then(() => {
                showNotification('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨! Ø´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰', 'success');
                
                // Show in a prompt as well
                prompt('ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© (ØªÙ… Ù†Ø³Ø®Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):', orderCode);
            }).catch(() => {
                prompt('ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', orderCode);
            });
        }
        
        function receiveOrder() {
            const code = document.getElementById('orderCodeInput').value.trim();
            if (!code) {
                showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ù„Ø¨', 'error');
                return;
            }
            
            const result = multiDB.receiveOrderFromCode(code);
            
            if (result.success) {
                document.getElementById('orderCodeInput').value = '';
                refreshData();
                showNotification(result.message + ': ' + result.order.orderId, 'success');
            } else {
                showNotification(result.message, 'error');
            }
        }
        
        function generateTestOrder() {
            // Create a test order with complete data
            const testOrder = {
                orderId: 'TEST-' + Date.now(),
                timestamp: Date.now(),
                customer: {
                    name: 'Ø¹Ù…ÙŠÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    phone: '01234567890',
                    email: 'test@customer.com',
                    city: 'Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©',
                    address: 'Ø¹Ù†ÙˆØ§Ù† ØªØ¬Ø±ÙŠØ¨ÙŠ'
                },
                products: [{
                    name: 'Ø­Ù‚ÙŠØ¨Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©',
                    price: 750,
                    quantity: 1
                }],
                totals: {
                    totalAmount: 750
                },
                paymentMethod: 'cash_on_delivery'
            };
            
            // Save as local order
            const localOrders = JSON.parse(localStorage.getItem('forsa_complete_orders') || '[]');
            localOrders.push(testOrder);
            localStorage.setItem('forsa_complete_orders', JSON.stringify(localOrders));
            
            // Generate share code
            const orderCode = multiDB.generateOrderCode(testOrder);
            
            refreshData();
            prompt('ÙƒÙˆØ¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ (ØªÙ… Ù†Ø³Ø®Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):', orderCode);
            navigator.clipboard.writeText(orderCode);
            showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ ØªØ¬Ø±ÙŠØ¨ÙŠ ÙˆÙ†Ø³Ø® ÙƒÙˆØ¯ Ù…Ø´Ø§Ø±ÙƒØªÙ‡!', 'success');
        }
        
        function simulateRemoteOrder() {
            // Create a realistic order from "another device"
            const remoteOrder = {
                orderId: 'REMOTE-' + Date.now(),
                timestamp: Date.now(),
                customer: {
                    name: 'Ø¹Ù…ÙŠÙ„Ø© Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±',
                    phone: '01098765432',
                    email: 'remote@customer.com',
                    city: 'Ø§Ù„Ø¬ÙŠØ²Ø©',
                    address: 'Ø¹Ù†ÙˆØ§Ù† Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±'
                },
                products: [{
                    name: 'Ø­Ù‚ÙŠØ¨Ø© Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±',
                    price: 920,
                    quantity: 2
                }],
                totals: {
                    totalAmount: 1840
                },
                paymentMethod: 'cash_on_delivery',
                source: 'remote',
                deviceId: 'DEVICE-SIMULATOR-' + Math.random().toString(36).substr(2, 8),
                receivedAt: Date.now(),
                receivedBy: multiDB.deviceId
            };
            
            // Simulate receiving this order
            multiDB.saveReceivedOrder(remoteOrder);
            refreshData();
            showNotification('ØªÙ… Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨ Ù…Ù† Ø¬Ù‡Ø§Ø² Ø¢Ø®Ø±!', 'success');
        }
        
        function shareNetworkCode() {
            const networkCode = btoa(JSON.stringify({
                networkId: multiDB.networkId,
                deviceId: multiDB.deviceId,
                sharedAt: Date.now()
            }));
            
            document.getElementById('qrCodeDisplay').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; font-family: monospace; word-break: break-all; font-size: 12px;">
                    ${networkCode}
                </div>
            `;
            document.getElementById('qrCodeSection').style.display = 'block';
            
            navigator.clipboard.writeText(networkCode);
            showNotification('ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø´Ø¨ÙƒØ©!', 'success');
        }
        
        function exportAllData() {
            const data = {
                deviceId: multiDB.deviceId,
                networkId: multiDB.networkId,
                exportedAt: new Date().toISOString(),
                orders: multiDB.orders,
                stats: multiDB.getStats()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `forsa_multi_device_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'success');
        }
        
        function clearAllData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {
                localStorage.removeItem('forsa_received_orders');
                multiDB.loadLocalData();
                refreshData();
                showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ø© Ù…Ù† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ø®Ø±Ù‰', 'warning');
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: bold;
                transform: translateX(400px);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 4000);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
        });
    </script>
</body>
</html>